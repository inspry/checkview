name: Check WordPress Plugin SVN Updates

on:
    push:
      branches:
        - bug-fixes
    schedule:
        - cron: '0 * * * *' # Runs every hour

    workflow_dispatch: # Allow manual trigger

jobs:
  check-svn-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up SVN
        run: sudo apt-get install -y subversion

      - name: Check for latest SVN revision
        id: check-svn
        run: |
          svn info https://plugins.svn.wordpress.org/ninja-forms/trunk | grep 'Last Changed Rev' | awk '{print $4}' > current_revision.txt

      - name: Get previous SVN revision
        id: get-previous
        run: |
          if [ -f previous_revision.txt ]; then
            cat previous_revision.txt
          else
            echo "0" > previous_revision.txt
          fi
        continue-on-error: true

      - name: Compare revisions
        id: compare-revisions
        run: |
          current_revision=$(cat current_revision.txt)
          previous_revision=$(cat previous_revision.txt)

          echo "Current revision: $current_revision"
          echo "Previous revision: $previous_revision"

          if [ "$current_revision" -gt "$previous_revision" ]; then
            echo "::set-output name=update_found::true"
            echo "::set-output name=current_revision::$current_revision"
          else
            echo "::set-output name=update_found::false"
          fi

      - name: Save current revision as previous revision
        if: steps.compare-revisions.outputs.update_found == 'true'
        run: |
          cp current_revision.txt previous_revision.txt

      - name: Commit updated revision file
        if: steps.compare-revisions.outputs.update_found == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add previous_revision.txt
          git commit -m 'Update Ninja Forms SVN revision'
          git push

      - name: Run subsequent actions
        if: steps.compare-revisions.outputs.update_found == 'true'
        run: |
          echo "New revision found, running subsequent actions..."
          # Place your subsequent actions here, such as deployment or testing.
